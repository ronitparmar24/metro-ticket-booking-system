<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Metro Ticket System</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš†</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
            --info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
        }
        
        /* Animated Background Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 20s infinite ease-in-out;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(50px, -50px) rotate(120deg); }
            66% { transform: translate(-50px, 50px) rotate(240deg); }
        }
        
        /* Modern Glassmorphism Navbar */
        .dashboard-navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 15px 0;
        }
        
        .dashboard-navbar .navbar-brand {
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-size: 24px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Floating Sidebar */
        .sidebar {
            position: fixed;
            top: 90px;
            left: 20px;
            width: 280px;
            height: calc(100vh - 110px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            padding: 30px 0;
            overflow-y: auto;
            z-index: 100;
            animation: slideInLeft 0.5s ease;
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* User Profile Card in Sidebar */
        .user-profile-card {
            text-align: center;
            padding: 20px;
            margin: 0 20px 30px;
            background: var(--primary);
            border-radius: 20px;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .user-avatar-circle {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            color: #667eea;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            animation: rotate 10s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .user-balance-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 50px;
            margin-top: 10px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        /* --- ADD THIS TO YOUR CSS TO FIX DARK MODE --- */

/* 1. Make Sidebar Dark */
.dark-mode .sidebar {
    background: rgba(20, 10, 40, 0.95) !important; /* Deep Purple/Black */
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
}

/* 2. Make Sidebar Links Light */
.dark-mode .sidebar-link {
    color: rgba(255, 255, 255, 0.7) !important;
}

.dark-mode .sidebar-link:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    color: white !important;
}

/* 3. Fix the Active Link in Dark Mode */
.dark-mode .sidebar-link.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
}

/* 4. Fix User Profile Card in Sidebar */
.dark-mode .user-profile-card {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.dark-mode .user-avatar-circle {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

/* 5. Fix Tables & Dropdowns */
.dark-mode .table {
    color: rgba(255, 255, 255, 0.9) !important;
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .dropdown-menu {
    background: #1a0b2e !important;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.dark-mode .dropdown-item {
    color: rgba(255, 255, 255, 0.8) !important;
}

.dark-mode .dropdown-item:hover {
    background: rgba(255, 255, 255, 0.1) !important;
}
        /* Sidebar Links with Icons */
        

/* 1. The Container - Bouncy Entrance */
.sidebar {
    position: fixed;
    top: 90px;
    left: 20px;
    width: 280px;
    height: calc(100vh - 110px);
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(25px); /* Stronger blur for glass effect */
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 25px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    padding: 30px 0;
    overflow-y: auto;
    z-index: 100;
    
    /* The Magic: Elastic Animation */
    animation: slideInElastic 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform-origin: left center;
}

/* 2. The Links - Faster Cascade */
.sidebar-link {
    padding: 15px 30px;
    display: flex;
    align-items: center;
    color: #64748b;
    text-decoration: none;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy hover */
    border-left: 4px solid transparent;
    position: relative;
    overflow: hidden;
    margin: 5px 15px; /* Add spacing between items */
    border-radius: 12px; /* Rounded corners for links */
    
    /* Start hidden for stagger animation */
    opacity: 0;
    animation: fadeInUpStagger 0.5s ease forwards;
}

/* 3. Stagger Delays (Waterfall effect but FAST) */
.sidebar-link:nth-child(1) { animation-delay: 0.05s; }
.sidebar-link:nth-child(2) { animation-delay: 0.1s; }
.sidebar-link:nth-child(3) { animation-delay: 0.15s; }
.sidebar-link:nth-child(4) { animation-delay: 0.2s; }
.sidebar-link:nth-child(5) { animation-delay: 0.25s; }
.sidebar-link:nth-child(6) { animation-delay: 0.3s; }
.sidebar-link:nth-child(7) { animation-delay: 0.35s; }
.sidebar-link:nth-child(8) { animation-delay: 0.4s; }
.sidebar-link:nth-child(9) { animation-delay: 0.45s; }
.sidebar-link:nth-child(10) { animation-delay: 0.5s; }
.sidebar-link:nth-child(11) { animation-delay: 0.55s; }

/* 4. Active & Hover States - "Pop" Effect */
.sidebar-link:hover {
    background: white;
    color: #667eea;
    transform: translateX(10px) scale(1.02); /* Moves right and grows slightly */
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.15);
}

.sidebar-link.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    transform: translateX(5px);
    border-left: none; /* Removed border, using full background now */
}

/* 5. Icons in Links */
.sidebar-link i {
    width: 35px;
    margin-right: 10px;
    font-size: 20px;
    text-align: center;
    transition: transform 0.3s ease;
}

.sidebar-link:hover i {
    transform: scale(1.2) rotate(5deg); /* Icon pops on hover */
}

/* 6. Animations Keyframes */
@keyframes slideInElastic {
    0% { transform: translateX(-100%) scale(0.8); opacity: 0; }
    100% { transform: translateX(0) scale(1); opacity: 1; }
}

@keyframes fadeInUpStagger {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
        
        /* Main Content Area */
        .main-content {
            margin-left: 320px;
            margin-top: 90px;
            padding: 30px;
            position: relative;
            z-index: 1;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Glassmorphism Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.25);
        }
        
        /* Enhanced Stat Cards */
        .stat-card-modern {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .stat-card-modern::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: var(--primary);
            opacity: 0.05;
            transform: rotate(45deg);
            transition: all 0.5s ease;
        }
        
        .stat-card-modern:hover::before {
            top: -100%;
            right: -100%;
        }
        
        .stat-card-modern:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }
        
        .stat-icon-box {
            width: 65px;
            height: 65px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card-modern.gradient-1 .stat-icon-box { background: var(--primary); }
        .stat-card-modern.gradient-2 .stat-icon-box { background: var(--secondary); }
        .stat-card-modern.gradient-3 .stat-icon-box { background: var(--info); }
        .stat-card-modern.gradient-4 .stat-icon-box { background: var(--success); }
        .stat-card-modern.gradient-5 .stat-icon-box { background: var(--warning); }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Quick Action Buttons */
        .quick-action-btn {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 18px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            display: block;
            color: #334155;
        }
        
        .quick-action-btn:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
            color: #667eea;
        }
        
        .quick-action-btn i {
            font-size: 40px;
            margin-bottom: 15px;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Enhanced Ticket Card */
        .ticket-card-3d {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px;
            color: white;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .ticket-card-3d::before {
            content: '';
            position: absolute;
            top: -100px;
            right: -100px;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .ticket-card-3d:hover {
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 25px 60px rgba(102, 126, 234, 0.5);
        }
        
        .ticket-route {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .station-dot {
            width: 15px;
            height: 15px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .route-line {
            flex: 1;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            margin: 0 15px;
            position: relative;
        }
        
        .route-line::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: white;
            animation: routeProgress 2s ease-in-out infinite;
        }
        
        @keyframes routeProgress {
            0%, 100% { width: 0; }
            50% { width: 100%; }
        }
        
        /* Animated Form Inputs */
        .form-group-modern {
            position: relative;
            margin-bottom: 30px;
        }
        
        .form-control-modern {
            width: 100%;
            padding: 15px 20px 15px 55px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-control-modern:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .form-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 20px;
        }
        
        .form-label-modern {
            font-weight: 600;
            color: #334155;
            margin-bottom: 10px;
            display: block;
        }
        
        /* Animated Button */
        .btn-gradient {
            background: var(--primary);
            border: none;
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-gradient::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-gradient:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }
        
        /* Badge Styles */
        .badge-modern {
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
        }
        
        .badge-success { background: var(--success); color: white; }
        .badge-danger { background: var(--secondary); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-info { background: var(--info); color: white; }
        
        /* Progress Bar */
        .progress-modern {
            height: 8px;
            background: #e2e8f0;
            border-radius: 50px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-bar-modern {
            height: 100%;
            background: var(--primary);
            border-radius: 50px;
            transition: width 1s ease;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                left: 0;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
        /* --- ADD THIS TO YOUR CSS --- */
        .badge-completed { 
             background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); 
             color: white; 
        }
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        /* --- PASTE THIS AT THE END OF YOUR CSS TO FIX TEXT VISIBILITY --- */

/* 1. Fix Stat Cards (Numbers & Labels) */
.dark-mode .stat-value {
    -webkit-text-fill-color: white !important; /* Turn off the gradient text */
    background: none !important;
    color: white !important;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.3); /* Add glow */
}

.dark-mode .text-muted {
    color: rgba(255, 255, 255, 0.6) !important; /* Make grey text readable */
}

.dark-mode small.text-muted {
    color: rgba(255, 255, 255, 0.5) !important;
}

/* 2. Fix Quick Action Buttons */
.dark-mode .quick-action-btn {
    background: rgba(255, 255, 255, 0.05) !important; /* Dark glass background */
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white !important;
}

.dark-mode .quick-action-btn h6 {
    color: white !important;
}

.dark-mode .quick-action-btn i {
    -webkit-text-fill-color: #a78bfa !important; /* Bright Lavender Icon */
    background: none !important;
    color: #a78bfa !important;
}

.dark-mode .quick-action-btn:hover {
    background: rgba(255, 255, 255, 0.15) !important;
    border-color: #a78bfa;
    transform: translateY(-5px);
}

/* 3. Fix Input Forms (Booking & Settings) */
.dark-mode .form-label-modern {
    color: rgba(255, 255, 255, 0.9) !important;
}

.dark-mode .form-control-modern {
    background: rgba(0, 0, 0, 0.3) !important; /* Darker input background */
    border-color: rgba(255, 255, 255, 0.1) !important;
    color: white !important;
}

.dark-mode .form-control-modern::placeholder {
    color: rgba(255, 255, 255, 0.3);
}

.dark-mode .form-icon {
    color: #a78bfa !important;
}

/* 4. Fix Select Dropdowns (Source/Destination) */
.dark-mode select.form-control-modern option {
    background: #1a0b2e; /* Dark background for dropdown list */
    color: white;
}

/* 5. Fix Headings inside Glass Cards */
.dark-mode .glass-card h4, 
.dark-mode .glass-card h5, 
.dark-mode .glass-card h6 {
    color: white !important;
}

.dark-mode .glass-card i {
    /* Make headers icons bright */
    text-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
}

    /* Chatbot Widget */
.chat-widget {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 350px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none; /* Hidden by default */
    overflow: hidden;
    border: 1px solid #eee;
}
.chat-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.chat-body {
    height: 300px;
    overflow-y: auto;
    padding: 15px;
    background: #f8f9fa;
}
.chat-msg {
    margin-bottom: 10px;
    padding: 10px 15px;
    border-radius: 15px;
    max-width: 80%;
    font-size: 0.9rem;
}
.msg-bot { background: #e9ecef; color: #333; border-bottom-left-radius: 2px; }
.msg-user { background: #667eea; color: white; margin-left: auto; border-bottom-right-radius: 2px; }

/* Floating Action Buttons */
.fab-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 15px;
    z-index: 1000;
}
.btn-fab {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    transition: transform 0.3s;
    border: none;
    cursor: pointer;
}
.btn-fab:hover { transform: translateY(-5px); }
.btn-chat { background: linear-gradient(135deg, #667eea, #764ba2); }
.btn-sos { background: linear-gradient(135deg, #ff416c, #ff4b2b); animation: pulse 2s infinite; }

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(255, 65, 108, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0); }
}

/* Map Modal Styling */
.metro-map-line {
    height: 8px;
    border-radius: 4px;
    position: relative;
    margin: 40px 0;
}
.metro-station-dot {
    width: 20px; height: 20px;
    background: white;
    border: 4px solid;
    border-radius: 50%;
    position: absolute;
    top: -6px;
    cursor: pointer;
    transition: 0.2s;
}
.metro-station-dot:hover { transform: scale(1.5); }

/* --- Add this to your existing <style> block --- */

/* Facility Card Styling for Modal */
.facility-card {
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.05);
}
.facility-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* Modern Input Group for Select + Button */
.input-group-modern {
    display: flex;
    align-items: stretch;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

.input-group-modern .form-control-modern {
    border-radius: 0;
    border: none;
    flex: 1;
}

.input-group-modern .input-group-text {
    background: white;
    border: none;
    padding-left: 20px;
    color: #667eea;
}

.input-group-modern .btn-info-modern {
    background: #f8f9fa;
    border: none;
    border-left: 1px solid #e2e8f0;
    padding: 0 20px;
    color: #3b82f6;
    transition: all 0.2s;
}

.input-group-modern .btn-info-modern:hover {
    background: #eff6ff;
    color: #2563eb;
}

/* Dark Mode Support for Modal */
.dark-mode .modal-content {
    background: #1e1e2d;
    color: white;
}
.dark-mode .facility-card.bg-light {
    background: rgba(255,255,255,0.05) !important;
    border-color: rgba(255,255,255,0.1);
}
.dark-mode .facility-card i.text-muted {
    color: rgba(255,255,255,0.4) !important;
}
.dark-mode .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
}
/* FORCE MODAL TO FRONT */
.modal-backdrop {
    z-index: 10000 !important; /* Higher than navbar */
}
.modal {
    z-index: 10001 !important; /* Higher than backdrop */
    background: rgba(0, 0, 0, 0.5); /* Fallback dimming */
}
    </style>
</head>
<body>
    <!-- Animated Background Particles -->
    <div class="particles" id="particles"></div>

    <!-- Modern Navbar -->
    <nav class="dashboard-navbar">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center">
                <div class="navbar-brand">
                    <div class="logo-icon">
                        <i class="fas fa-train"></i>
                    </div>
                    <span>Metro Dashboard</span>
                </div>
                
      <div class="d-flex align-items-center gap-3">
    
    <button class="btn btn-link text-white" onclick="toggleDarkMode()" title="Toggle Dark Mode">
        <i class="fas fa-moon" style="font-size: 22px;"></i>
    </button>

    <div class="dropdown">
        <button class="btn btn-link text-white position-relative" type="button" data-bs-toggle="dropdown" onclick="markAsRead()">
            <i class="fas fa-bell" style="font-size: 22px;"></i>
            <span class="notification-badge" id="notificationCount">0</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end" id="notifDropdown" style="width: 300px; max-height: 400px; overflow-y: auto;">
            <li class="dropdown-header">Recent Alerts</li>
            <div id="notifList">
                <li><a class="dropdown-item small text-muted">No notifications</a></li>
            </div>
        </ul>
    </div>
    
    <div class="dropdown">
        <button class="btn text-white dropdown-toggle d-flex align-items-center gap-2" 
                type="button" data-bs-toggle="dropdown" 
                style="background: rgba(255,255,255,0.1); border-radius: 50px; padding: 8px 20px;">
            <i class="fas fa-user-circle" style="font-size: 24px;"></i>
            <span id="navUsername">User</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end" style="border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <li><a class="dropdown-item" href="#" onclick="showSection('profile')">
                <i class="fas fa-user me-2"></i>Profile Settings
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="showSection('wallet')">
                <i class="fas fa-wallet me-2"></i>My Wallet
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#" onclick="API.logout()">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </a></li>
        </ul>
    </div>
</div>
            </div>
        </div>
    </nav>
    <div style="position: fixed; top: 75px; left: 0; right: 0; background: #fff; z-index: 900; 
            border-bottom: 1px solid #e2e8f0; height: 30px; display: flex; align-items: center; 
            overflow: hidden; white-space: nowrap;">
    <div style="background: #ef4444; color: white; padding: 0 15px; height: 100%; 
                display: flex; align-items: center; font-size: 12px; font-weight: bold; z-index: 2;">
        LIVE UPDATES
    </div>
    <div style="animation: ticker 20s linear infinite; display: inline-block; padding-left: 100%;">
        <span class="mx-4"><i class="fas fa-info-circle text-primary me-2"></i>Blue Line operating normally</span>
        <span class="mx-4"><i class="fas fa-clock text-warning me-2"></i>Peak hours: 8 AM - 11 AM</span>
        <span class="mx-4"><i class="fas fa-mask text-success me-2"></i>Masks are recommended during travel</span>
        <span class="mx-4"><i class="fas fa-tools text-muted me-2"></i>Maintenance scheduled for Sunday 2 AM</span>
    </div>
</div>

<style>
@keyframes ticker {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
}
/* Push content down slightly to fit ticker */
.sidebar { top: 110px !important; height: calc(100vh - 130px) !important; }
.main-content { margin-top: 110px !important; }
</style>
    <!-- Floating Sidebar -->
    <div class="sidebar" id="sidebar">
        <!-- User Profile Card -->
        <div class="user-profile-card" data-aos="zoom-in">
            <div class="user-avatar-circle">
                <i class="fas fa-user"></i>
            </div>
            <h5 class="mb-1" id="sidebarUsername">Loading...</h5>
            <small class="opacity-75">Metro Traveler</small>
            <div class="user-balance-badge">
                ðŸ’° â‚¹<span id="sidebarBalance">0</span>
            </div>
        </div>
        
        <!-- Navigation Links -->
        <a href="#" class="sidebar-link active" onclick="showSection('dashboard')">
    <i class="fas fa-th-large"></i>
    <span>Dashboard</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('book-ticket')">
    <i class="fas fa-ticket-alt"></i>
    <span>Book Ticket</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('my-tickets')">
    <i class="fas fa-list-ul"></i>
    <span>My Tickets</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('wallet')">
    <i class="fas fa-wallet"></i>
    <span>Wallet</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('metro-card')">
    <i class="fas fa-credit-card"></i>
    <span>Metro Card</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('monthly-pass')">
    <i class="fas fa-calendar-check"></i>
    <span>Monthly Pass</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('journey-history')">
    <i class="fas fa-history"></i>
    <span>Journey History</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('feedback')">
    <i class="fas fa-comment-alt"></i>
    <span>Feedback</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('profile')">
    <i class="fas fa-user-cog"></i>
    <span>Settings</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('transactions')">
    <i class="fas fa-exchange-alt"></i>
    <span>Transactions</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('analytics')">
    <i class="fas fa-chart-bar"></i>
    <span>Analytics</span>
</a>
<a href="#" class="sidebar-link" onclick="showSection('fare-calculator')">
    <i class="fas fa-calculator"></i>
    <span>Fare Calculator</span>
</a>

    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">Welcome Back, <span id="welcomeUsername">User</span>! ðŸ‘‹</h2>
                <p class="text-white opacity-75">Here's what's happening with your metro journey today</p>
            </div>
            
            <!-- Enhanced Stat Cards -->
            <div class="row g-4 mb-4">
                <div class="col-md-6 col-xl-3" data-aos="fade-up" data-aos-delay="100">
                    <div class="stat-card-modern gradient-1">
                        <div class="stat-icon-box">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <p class="text-muted mb-1">Wallet Balance</p>
                        <h3 class="stat-value mb-0">â‚¹<span id="dashboardBalance">0</span></h3>
                        <div class="progress-modern">
                            <div class="progress-bar-modern" style="width: 75%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-3" data-aos="fade-up" data-aos-delay="200">
                    <div class="stat-card-modern gradient-2">
                        <div class="stat-icon-box">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <p class="text-muted mb-1">Total Tickets</p>
                        <h3 class="stat-value mb-0" id="totalTickets">0</h3>
                        <small class="text-muted">All time bookings</small>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-3" data-aos="fade-up" data-aos-delay="300">
                    <div class="stat-card-modern gradient-3">
                        <div class="stat-icon-box">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <p class="text-muted mb-1">Upcoming Trips</p>
                        <h3 class="stat-value mb-0" id="upcomingTickets">0</h3>
                        <small class="text-muted">Ready to travel</small>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-3" data-aos="fade-up" data-aos-delay="400">
                    <div class="stat-card-modern gradient-4">
                        <div class="stat-icon-box">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <p class="text-muted mb-1">Metro Card</p>
                        <h3 class="stat-value mb-0">â‚¹<span id="metroCardBalance">0</span></h3>
                        <small class="text-muted">Quick pay balance</small>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="glass-card mb-4" data-aos="fade-up">
                <h4 class="mb-4">
                    <i class="fas fa-bolt text-warning me-2"></i>
                    Quick Actions
                </h4>
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <a href="#" class="quick-action-btn" onclick="showSection('book-ticket')">
                            <i class="fas fa-ticket-alt"></i>
                            <h6 class="mb-0">Book Ticket</h6>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="#" class="quick-action-btn" onclick="showSection('wallet')">
                            <i class="fas fa-plus-circle"></i>
                            <h6 class="mb-0">Add Money</h6>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="#" class="quick-action-btn" onclick="showSection('my-tickets')">
                            <i class="fas fa-list-ul"></i>
                            <h6 class="mb-0">View Tickets</h6>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="#" class="quick-action-btn" onclick="showSection('metro-card')">
                            <i class="fas fa-credit-card"></i>
                            <h6 class="mb-0">Metro Card</h6>
                        </a>
                    </div>
                </div>
            </div>
            <div class="row mt-4" data-aos="fade-up">
            <div class="row mt-4" data-aos="fade-up">
    <div class="col-md-6 mb-3">
        <div class="glass-card text-white" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5><i class="fas fa-leaf me-2"></i>Green Miles</h5>
                    <h2 class="fw-bold mb-0" id="loyaltyPointsDisplay">0</h2>
                    <small>Eco-Points Available</small>
                </div>
                <button onclick="redeemPoints()" class="btn btn-light text-success fw-bold rounded-pill">
                    Redeem 50 pts
                </button>
            </div>
            <div class="mt-2 small opacity-75">50 Points = â‚¹20 Wallet Credit</div>
        </div>
    </div>

   <div class="col-md-6 mb-3">
    <div class="glass-card h-100" style="border-left: 5px solid #f59e0b; position: relative; overflow: hidden;">
        <i class="fas fa-search" style="position: absolute; right: -10px; bottom: -20px; font-size: 100px; opacity: 0.1; transform: rotate(-20deg);"></i>
        
        <h5 class="mb-3"><i class="fas fa-search-location text-warning me-2"></i>Lost & Found</h5>
        
        <div class="d-flex gap-2">
            <input type="text" id="quickLostItemInput" class="form-control-modern" 
                   placeholder="What did you lose? (e.g., Blue Umbrella)" 
                   style="background: rgba(255,255,255,0.9);">
            
            <button class="btn btn-warning text-white fw-bold shadow-sm" 
                    onclick="submitQuickReport()" 
                    style="border-radius: 12px; padding: 0 20px; transition: all 0.3s;">
                Report
            </button>
        </div>
        
        <small class="text-muted mt-2 d-block">
            <i class="fas fa-info-circle me-1"></i> We'll notify you immediately if found.
        </small>
    </div>
</div>
</div>
</div>
            
            <!-- Recent Bookings -->
            <div class="glass-card" data-aos="fade-up">
                <h4 class="mb-4">
                    <i class="fas fa-clock text-info me-2"></i>
                    Recent Bookings
                </h4>
                <div id="recentTickets">
                    <div class="text-center py-4">
                        <div class="spinner-border" style="color: #667eea;" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Book Ticket Section -->
       <!-- Book Ticket Section - COMPLETE WORKING VERSION -->
<div id="book-ticket-section" class="content-section" style="display: none;">
    <div class="mb-4" data-aos="fade-down">
        <h2 class="text-white mb-2">
            <i class="fas fa-ticket-alt me-2"></i>Book Your Ticket
        </h2>
        <p class="text-white opacity-75">Choose your journey and travel smart!</p>
    </div>
    
    <div class="glass-card" data-aos="fade-up">
        <form id="bookTicketForm">
            <div class="row">
    <div class="col-md-6 mb-4">
        <label class="form-label-modern">
            <i class="fas fa-map-marker-alt text-success me-2"></i>From Station
        </label>
        <div class="input-group-modern">
            <span class="input-group-text">
                <i class="fas fa-location-arrow"></i>
            </span>
            <select class="form-control-modern" id="sourceStation" required onchange="updateFare()">
                <option value="">Select Source Station</option>
            </select>
            <button class="btn-info-modern" type="button" onclick="viewStationInfo('sourceStation')" title="View Station Facilities">
                <i class="fas fa-info-circle fa-lg"></i>
            </button>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <label class="form-label-modern">
            <i class="fas fa-map-marker-alt text-danger me-2"></i>To Station
        </label>
        <div class="input-group-modern">
            <span class="input-group-text">
                <i class="fas fa-map-marked-alt"></i>
            </span>
            <select class="form-control-modern" id="destinationStation" required onchange="updateFare()">
                <option value="">Select Destination Station</option>
            </select>
            <button class="btn-info-modern" type="button" onclick="viewStationInfo('destinationStation')" title="View Station Facilities">
                <i class="fas fa-info-circle fa-lg"></i>
            </button>
        </div>
    </div>
</div>
            
            <div class="row">
                <!-- Number of Passengers -->
                <div class="col-md-6 mb-4">
                    <div class="form-group-modern">
                        <label class="form-label-modern">
                            <i class="fas fa-users text-info me-2"></i>Passengers
                        </label>
                        <div class="position-relative">
                            <i class="form-icon fas fa-users"></i>
                            <input type="number" class="form-control-modern" id="passengers" 
                                   min="1" max="6" value="1" required 
                                   onchange="updateFare()" 
                                   oninput="updateFare()">
                        </div>
                        <small class="text-muted ms-2">Maximum 6 passengers allowed</small>
                    </div>
                </div>
                
                <!-- Travel Date -->
                <div class="col-md-6 mb-4">
                    <div class="form-group-modern">
                        <label class="form-label-modern">
                            <i class="fas fa-calendar text-warning me-2"></i>Travel Date
                        </label>
                        <div class="position-relative">
                            <i class="form-icon fas fa-calendar-day"></i>
                            <input type="date" class="form-control-modern" id="travelDate" required>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Fare Display -->
            <div class="alert" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1"><i class="fas fa-money-bill-wave me-2"></i>Total Fare</h5>
                        <small class="opacity-75">Base fare: â‚¹50 per passenger</small>
                    </div>
                    <h2 class="mb-0">â‚¹<span id="calculatedFare">50</span></h2>
                </div>
                <div class="progress-modern mt-3" style="background: rgba(255,255,255,0.2);">
                    <div class="progress-bar-modern" style="width: 100%; background: white;"></div>
                </div>
            </div>
            
            <button type="button" class="btn-gradient w-100" onclick="bookTicketNow()">
                <i class="fas fa-check-circle me-2"></i>
                <span>Book Now</span>
            </button>
        </form>
    </div>
</div>


        <!-- My Tickets Section -->
        <div id="my-tickets-section" class="content-section" style="display: none;">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">
                    <i class="fas fa-list-ul me-2"></i>My Tickets
                </h2>
                <p class="text-white opacity-75">View and manage all your bookings</p>
            </div>
            
            <div class="glass-card mb-4" data-aos="fade-up">
    <div class="d-flex gap-2 flex-wrap">
        <button id="btn-filter-all" class="btn btn-sm btn-gradient" onclick="filterTickets('all')" style="padding: 10px 25px;">
            <i class="fas fa-list me-2"></i>All Tickets
        </button>
        
        <button id="btn-filter-upcoming" class="btn btn-sm btn-glass-secondary" onclick="filterTickets('upcoming')">
            <i class="fas fa-arrow-up me-2"></i>Upcoming
        </button>
        
        <button id="btn-filter-past" class="btn btn-sm btn-glass-secondary" onclick="filterTickets('past')">
            <i class="fas fa-history me-2"></i>Past Trips
        </button>
    </div>
</div>            
            <div id="ticketsList">
                <div class="text-center py-4">
                    <div class="spinner-border" style="color: white;" role="status"></div>
                </div>
            </div>
        </div>

        <!-- Wallet Section -->
        <div id="wallet-section" class="content-section" style="display: none;">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">
                    <i class="fas fa-wallet me-2"></i>My Wallet
                </h2>
                <p class="text-white opacity-75">Manage your funds and transactions</p>
            </div>
            
            <!-- Wallet Balance Card -->
            <div class="row mb-4">
                <div class="col-lg-6" data-aos="zoom-in">
                    <div class="glass-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <div>
                                <p class="mb-2 opacity-75">Available Balance</p>
                                <h1 class="mb-0" style="font-size: 3rem; font-weight: 800;">
                                    â‚¹<span id="walletBalance">0</span>
                                </h1>
                            </div>
                            <div style="font-size: 60px; opacity: 0.2;">
                                <i class="fas fa-wallet"></i>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center pt-3" style="border-top: 1px solid rgba(255,255,255,0.2);">
                            <small class="opacity-75">Metro Wallet</small>
                            <small class="opacity-75">Active</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6" data-aos="zoom-in" data-aos-delay="100">
                    <div class="glass-card">
                        <h5 class="mb-4">
                            <i class="fas fa-plus-circle text-success me-2"></i>
                            Quick Recharge
                        </h5>
                        <form id="rechargeForm">
                            <div class="form-group-modern mb-3">
                                <label class="form-label-modern">Amount (â‚¹)</label>
                                <div class="position-relative">
                                    <i class="form-icon fas fa-rupee-sign"></i>
                                    <input type="number" class="form-control-modern" id="rechargeAmount" 
                                           min="100" max="5000" step="1" placeholder="Enter amount" required>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2 mb-3 flex-wrap">
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="setAmount(100)" style="border-radius: 50px;">â‚¹100</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="setAmount(250)" style="border-radius: 50px;">â‚¹250</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="setAmount(500)" style="border-radius: 50px;">â‚¹500</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="setAmount(1000)" style="border-radius: 50px;">â‚¹1000</button>
                            </div>
                            
                            <button type="submit" class="btn-gradient w-100">
                                <i class="fas fa-bolt me-2"></i>
                                <span>Recharge Now</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Transaction History (NEW) -->
            <div class="glass-card" data-aos="fade-up">
                <h5 class="mb-4">
                    <i class="fas fa-history me-2"></i>
                    Recent Transactions
                </h5>
               <div id="transactionHistory" style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                     <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                         <p class="text-muted mt-2">Loading transactions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metro Card Section -->
        <div id="metro-card-section" class="content-section" style="display: none;">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">
                    <i class="fas fa-credit-card me-2"></i>Metro Smart Card
                </h2>
                <p class="text-white opacity-75">Your contactless payment solution</p>
            </div>
            
            <div class="row">
                <div class="col-lg-6 mb-4" data-aos="flip-left">
                    <div id="metroCardDetails">
                        <div class="text-center py-4">
                            <div class="spinner-border" style="color: white;" role="status"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6" data-aos="fade-up">
                    <div class="glass-card">
                        <h5 class="mb-4">
                            <i class="fas fa-info-circle text-info me-2"></i>
                            Card Benefits
                        </h5>
                        <ul class="list-unstyled">
                            <li class="mb-3">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <strong>Instant Payment:</strong> No queue, just tap and go
                            </li>
                            <li class="mb-3">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <strong>Auto-Recharge:</strong> Never worry about low balance
                            </li>
                            <li class="mb-3">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <strong>Cashback Offers:</strong> Save more on every trip
                            </li>
                            <li class="mb-3">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <strong>Track Spending:</strong> View all transactions
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Pass Section (NEW FEATURE) -->
        <div id="monthly-pass-section" class="content-section" style="display: none;">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">
                    <i class="fas fa-calendar-check me-2"></i>Monthly Pass
                </h2>
                <p class="text-white opacity-75">Unlimited travel between your favorite routes</p>
            </div>
            
            <div class="row">
                <!-- Pass Plans -->
                <div class="col-lg-4 mb-4" data-aos="zoom-in" data-aos-delay="100">
                    <div class="glass-card text-center" style="border: 3px solid #667eea;">
                        <div class="mb-3" style="font-size: 50px; color: #667eea;">
                            <i class="fas fa-star"></i>
                        </div>
                        <h4>Basic Pass</h4>
                        <h2 class="my-3" style="color: #667eea; font-weight: 800;">â‚¹999</h2>
                        <p class="text-muted mb-4">Single Route | 30 Days</p>
                        <ul class="list-unstyled text-start mb-4">
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Unlimited trips</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>One fixed route</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Valid for 30 days</li>
                        </ul>
                        <button class="btn-gradient w-100">
                            <i class="fas fa-shopping-cart me-2"></i>Buy Now
                        </button>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4" data-aos="zoom-in" data-aos-delay="200">
                    <div class="glass-card text-center" style="border: 3px solid #f5576c; position: relative;">
                        <div class="position-absolute top-0 start-50 translate-middle">
                            <span class="badge-modern badge-danger">POPULAR</span>
                        </div>
                        <div class="mb-3 mt-3" style="font-size: 50px; color: #f5576c;">
                            <i class="fas fa-crown"></i>
                        </div>
                        <h4>Premium Pass</h4>
                        <h2 class="my-3" style="color: #f5576c; font-weight: 800;">â‚¹1,999</h2>
                        <p class="text-muted mb-4">Any 3 Routes | 30 Days</p>
                        <ul class="list-unstyled text-start mb-4">
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Unlimited trips</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Any 3 routes</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Priority boarding</li>
                        </ul>
                        <button class="btn-gradient w-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="fas fa-shopping-cart me-2"></i>Buy Now
                        </button>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4" data-aos="zoom-in" data-aos-delay="300">
                    <div class="glass-card text-center" style="border: 3px solid #38ef7d;">
                        <div class="mb-3" style="font-size: 50px; color: #38ef7d;">
                            <i class="fas fa-gem"></i>
                        </div>
                        <h4>Unlimited Pass</h4>
                        <h2 class="my-3" style="color: #38ef7d; font-weight: 800;">â‚¹3,499</h2>
                        <p class="text-muted mb-4">All Routes | 30 Days</p>
                        <ul class="list-unstyled text-start mb-4">
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Unlimited trips</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>All metro routes</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>VIP lounge access</li>
                        </ul>
                        <button class="btn-gradient w-100" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <i class="fas fa-shopping-cart me-2"></i>Buy Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="lost-found-section" class="content-section" style="display: none;">
    <h2 class="mb-4">Lost & Found Portal</h2>
    
    <div class="row">
        <div class="col-md-4">
            <div class="glass-card">
                <h5 class="mb-3">Report Lost Item</h5>
                <form onsubmit="reportLostItem(event)">
                    <div class="mb-3">
                        <label>Item Name</label>
                        <input type="text" id="lostItemName" class="form-control" required placeholder="e.g. Blue Umbrella">
                    </div>
                    <div class="mb-3">
                        <label>Description & Location</label>
                        <textarea id="lostItemDesc" class="form-control" rows="3" required placeholder="Left on seat near door..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Submit Report</button>
                </form>
            </div>
        </div>
        <div class="col-md-8">
            <div class="glass-card">
                <h5 class="mb-3">My Reports</h5>
                <div id="lostFoundList">
                    </div>
            </div>
        </div>
    </div>
</div>

        <!-- Journey History Section (NEW) -->
        <div id="journey-history-section" class="content-section" style="display: none;">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">
                    <i class="fas fa-history me-2"></i>Journey History
                </h2>
                <p class="text-white opacity-75">Track all your past travels</p>
            </div>
            
            <div class="glass-card" data-aos="fade-up">
                <div class="alert" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 15px;">
                    <i class="fas fa-chart-line me-2"></i>
                    <strong>Travel Statistics:</strong> You've traveled <strong id="totalDistance">0 km</strong> this month!
                </div>
                
                <div id="journeyTimeline">
                    <div class="alert alert-info" style="border-radius: 15px;">
                        <i class="fas fa-info-circle me-2"></i>
                        Your journey history will appear here after your first trip!
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback Section -->
        <div id="feedback-section" class="content-section" style="display: none;">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">
                    <i class="fas fa-comment-alt me-2"></i>Feedback & Support
                </h2>
                <p class="text-white opacity-75">Help us serve you better</p>
            </div>
            
            <div class="glass-card mb-4" data-aos="fade-up">
                <form id="feedbackForm">
                    <div class="form-group-modern mb-3">
                        <label class="form-label-modern">Feedback Type</label>
                        <div class="position-relative">
                            <i class="form-icon fas fa-tag"></i>
                            <select class="form-control-modern" id="feedbackType">
                                <option value="feedback">ðŸ’¬ General Feedback</option>
                                <option value="complaint">âš ï¸ Complaint</option>
                                <option value="suggestion">ðŸ’¡ Suggestion</option>
                                <option value="praise">â­ Praise</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group-modern mb-4">
                        <label class="form-label-modern">Your Message</label>
                        <textarea class="form-control-modern" id="feedbackText" rows="5" 
                                  placeholder="Share your thoughts with us..." required 
                                  style="padding-left: 20px;"></textarea>
                    </div>
                    
                    <button type="submit" class="btn-gradient">
                        <i class="fas fa-paper-plane me-2"></i>
                        <span>Submit Feedback</span>
                    </button>
                </form>
            </div>
            
            <div class="glass-card" data-aos="fade-up">
                <h5 class="mb-4">
                    <i class="fas fa-comments me-2"></i>
                    My Feedbacks
                </h5>
                <div id="myFeedbacks">
                    <div class="text-center py-4">
                        <div class="spinner-border" style="color: #667eea;" role="status"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Settings Section -->
        <div id="profile-section" class="content-section" style="display: none;">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">
                    <i class="fas fa-user-cog me-2"></i>Profile Settings
                </h2>
                <p class="text-white opacity-75">Manage your account preferences</p>
            </div>
            
            <div class="row">
                <div class="col-lg-6 mb-4" data-aos="fade-right">
                    <div class="glass-card">
                        <h5 class="mb-4">
                            <i class="fas fa-key me-2"></i>
                            Change Password
                        </h5>
                        <form id="changePasswordForm">
                            <div class="form-group-modern mb-3">
                                <label class="form-label-modern">Current Password</label>
                                <div class="position-relative">
                                    <i class="form-icon fas fa-lock"></i>
                                    <input type="password" class="form-control-modern" id="oldPassword" required>
                                </div>
                            </div>
                            
                            <div class="form-group-modern mb-3">
                                <label class="form-label-modern">New Password</label>
                                <div class="position-relative">
                                    <i class="form-icon fas fa-lock"></i>
                                    <input type="password" class="form-control-modern" id="newPassword" required minlength="6">
                                </div>
                                <small class="text-muted ms-2">Minimum 6 characters</small>
                            </div>
                            
                            <button type="submit" class="btn-gradient">
                                <i class="fas fa-check me-2"></i>
                                <span>Update Password</span>
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4" data-aos="fade-left">
                    <div class="glass-card">
                        <h5 class="mb-4">
                            <i class="fas fa-user-circle me-2"></i>
                            Account Information
                        </h5>
                        <div class="mb-3">
                            <label class="form-label-modern">Username</label>
                            <input type="text" class="form-control-modern" id="profileUsername" readonly 
                                   style="background: #f8f9fa; padding-left: 20px;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label-modern">Account Type</label>
                            <input type="text" class="form-control-modern" value="Metro User" readonly 
                                   style="background: #f8f9fa; padding-left: 20px;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label-modern">Member Since</label>
                            <input type="text" class="form-control-modern" value="January 2026" readonly 
                                   style="background: #f8f9fa; padding-left: 20px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
                <!-- Transaction History Section (NEW) -->
        <div id="transactions-section" class="content-section" style="display: none;">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">
                    <i class="fas fa-exchange-alt me-2"></i>Transaction History
                </h2>
                <p class="text-white opacity-75">View all your payment transactions</p>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-4" data-aos="zoom-in">
                    <div class="stat-card-modern gradient-1">
                        <div class="stat-icon-box">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <p class="text-muted mb-1">Total Spent</p>
                        <h3 class="stat-value mb-0">â‚¹<span id="totalSpent">0</span></h3>
                        <small class="text-muted">All time spending</small>
                    </div>
                </div>
                
                <div class="col-md-4" data-aos="zoom-in" data-aos-delay="100">
                    <div class="stat-card-modern gradient-2">
                        <div class="stat-icon-box">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <p class="text-muted mb-1">Total Transactions</p>
                        <h3 class="stat-value mb-0" id="totalTransactions">0</h3>
                        <small class="text-muted">Successful bookings</small>
                    </div>
                </div>
                
                <div class="col-md-4" data-aos="zoom-in" data-aos-delay="200">
                    <div class="stat-card-modern gradient-3">
                        <div class="stat-icon-box">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <p class="text-muted mb-1">Avg Per Trip</p>
                        <h3 class="stat-value mb-0">â‚¹<span id="avgPerTrip">0</span></h3>
                        <small class="text-muted">Average spending</small>
                    </div>
                </div>
            </div>
            
            <div class="glass-card" data-aos="fade-up">
                <h5 class="mb-4">
                    <i class="fas fa-list me-2"></i>Recent Transactions
                </h5>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Route</th>
                                <th>Passengers</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <tr><td colspan="5" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Section (NEW) -->
        <div id="analytics-section" class="content-section" style="display: none;">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">
                    <i class="fas fa-chart-bar me-2"></i>Travel Analytics
                </h2>
                <p class="text-white opacity-75">Your travel patterns and insights</p>
            </div>
            
            <!-- Spending Chart -->
            <div class="glass-card mb-4" data-aos="fade-up">
                <h5 class="mb-4">
                    <i class="fas fa-chart-line me-2"></i>Monthly Spending
                </h5>
                <div id="monthlyChart" style="height: 300px;">
                    <canvas id="spendingChart"></canvas>
                </div>
            </div>
            
            <!-- Favorite Routes -->
            <div class="glass-card" data-aos="fade-up">
                <h5 class="mb-4">
                    <i class="fas fa-star me-2"></i>Most Traveled Routes
                </h5>
                <div id="favoriteRoutesList">
                    <div class="text-center py-4">
                        <div class="spinner-border" style="color: #667eea;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fare Calculator Section (NEW) -->
        <div id="fare-calculator-section" class="content-section" style="display: none;">
            <div class="mb-4" data-aos="fade-down">
                <h2 class="text-white mb-2">
                    <i class="fas fa-calculator me-2"></i>Fare Calculator
                </h2>
                <p class="text-white opacity-75">Calculate fare before booking</p>
            </div>
            
            <div class="row">
                <div class="col-lg-6 mb-4" data-aos="fade-right">
                    <div class="glass-card">
                        <h5 class="mb-4">Calculate Your Fare</h5>
                        <form id="fareCalcForm">
                            <div class="form-group-modern mb-3">
                                <label class="form-label-modern">From Station</label>
                                <div class="position-relative">
                                    <i class="form-icon fas fa-map-marker-alt"></i>
                                    <select class="form-control-modern" id="calcSource" required>
                                        <option value="">Select Source</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group-modern mb-3">
                                <label class="form-label-modern">To Station</label>
                                <div class="position-relative">
                                    <i class="form-icon fas fa-map-marked-alt"></i>
                                    <select class="form-control-modern" id="calcDest" required>
                                        <option value="">Select Destination</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group-modern mb-4">
                                <label class="form-label-modern">Number of Passengers</label>
                                <div class="position-relative">
                                    <i class="form-icon fas fa-users"></i>
                                    <input type="number" class="form-control-modern" id="calcPassengers" 
                                           min="1" max="6" value="1" required>
                                </div>
                            </div>
                            
                            <button type="button" class="btn-gradient w-100" onclick="calculateDetailedFare()">
                                <i class="fas fa-calculator me-2"></i>Calculate Fare
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="col-lg-6" data-aos="fade-left">
                    <div class="glass-card" id="fareResult" style="display: none;">
                        <h5 class="mb-4">
                            <i class="fas fa-receipt me-2"></i>Fare Breakdown
                        </h5>
                        <div class="fare-detail-card">
                            <div class="d-flex justify-content-between mb-3 pb-3" style="border-bottom: 2px dashed #e2e8f0;">
                                <span>Base Fare (per person)</span>
                                <strong>â‚¹50</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3 pb-3" style="border-bottom: 2px dashed #e2e8f0;">
                                <span>Number of Passengers</span>
                                <strong id="farePassengers">1</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3 pb-3" style="border-bottom: 2px dashed #e2e8f0;">
                                <span>Distance (approx)</span>
                                <strong id="fareDistance">5 km</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3 pb-3" style="border-bottom: 2px dashed #e2e8f0;">
                                <span>Estimated Time</span>
                                <strong id="fareTime">15 mins</strong>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3" 
                                 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                        border-radius: 15px; color: white;">
                                <h5 class="mb-0">Total Fare</h5>
                                <h3 class="mb-0">â‚¹<span id="fareTotalAmount">50</span></h3>
                            </div>
                        </div>
                        <button class="btn-gradient w-100 mt-3" onclick="bookFromCalculator()">
                            <i class="fas fa-ticket-alt me-2"></i>Book This Journey
                        </button>
                    </div>
                    
                    <!-- Fare Info -->
                    <div class="glass-card mt-4">
                        <h6 class="mb-3">
                            <i class="fas fa-info-circle me-2"></i>Fare Information
                        </h6>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Base fare: â‚¹50 per person
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Metro card: 5% discount
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Monthly pass: Unlimited travel
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Group booking: Same fare
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dark Mode Toggle (Add to navbar) -->
        <style>
            .dark-mode {
                background: linear-gradient(135deg, #2d1b4e 0%, #1a0b2e 100%) !important;
            }
            
            .dark-mode .glass-card {
                background: rgba(45, 27, 78, 0.8) !important;
                color: white !important;
            }
            
            .dark-mode .stat-card-modern {
                background: rgba(45, 27, 78, 0.9) !important;
                color: white !important;
            }
            
            .dark-mode .form-control-modern {
                background: rgba(255, 255, 255, 0.1) !important;
                color: white !important;
                border-color: rgba(255, 255, 255, 0.2) !important;
            }

            /* --- NEW SMART BUTTON STYLE --- */

/* 1. Light Mode Default (Dark Text on Grey) */
.btn-glass-secondary {
    background: rgba(100, 116, 139, 0.1); /* Light Grey background */
    color: #475569; /* Dark Grey text */
    border: none;
    border-radius: 50px;
    padding: 10px 25px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-glass-secondary:hover {
    background: rgba(100, 116, 139, 0.2);
    color: #1e293b;
    transform: translateY(-2px);
}

/* 2. Dark Mode Override (White Text on Glass) */
.dark-mode .btn-glass-secondary {
    background: rgba(255, 255, 255, 0.15) !important;
    color: white !important;
}

.dark-mode .btn-glass-secondary:hover {
    background: rgba(255, 255, 255, 0.25) !important;
}

        </style>

    </div>
    <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px;">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="fas fa-qrcode me-2"></i>Ticket QR Code</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center pb-4">
                <div class="bg-white p-3 rounded-3 d-inline-block mb-3 shadow">
                    <img id="qrImageDisplay" src="" alt="QR Code" class="img-fluid" style="width: 200px; height: 200px;">
                </div>
                <p class="opacity-75 mb-4">Show this QR code at the metro station gate</p>
                
                <a id="qrDownloadBtn" href="#" download="metro-ticket.png" class="btn btn-light text-primary fw-bold px-4 py-2" style="border-radius: 50px;">
                    <i class="fas fa-download me-2"></i>Save to Gallery
                </a>
            </div>
        </div>
    </div>
    
</div>
<div class="modal fade" id="stationInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" style="font-size: 1.5rem;">
                    <i class="fas fa-building me-2 text-primary"></i>
                    <span id="modalStationName">Station Info</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4">
                <div class="mb-4">
                    <span class="badge bg-success px-3 py-2 rounded-pill shadow-sm">
                        <i class="fas fa-check-circle me-1"></i> Fully Operational
                    </span>
                    <span class="ms-2 text-muted small" id="modalStationId">ID: #001</span>
                </div>

                <div class="row g-3 text-center mb-4">
                    <div class="col-4">
                        <div class="p-3 rounded-3 bg-light facility-card" id="fac_wifi">
                            <i class="fas fa-wifi fa-lg mb-2 text-muted"></i>
                            <div class="small fw-bold">WiFi</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 rounded-3 bg-light facility-card" id="fac_parking">
                            <i class="fas fa-parking fa-lg mb-2 text-muted"></i>
                            <div class="small fw-bold">Parking</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 rounded-3 bg-light facility-card" id="fac_access">
                            <i class="fab fa-accessible-icon fa-lg mb-2 text-muted"></i>
                            <div class="small fw-bold">Access</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 rounded-3 bg-light facility-card" id="fac_wc">
                            <i class="fas fa-restroom fa-lg mb-2 text-muted"></i>
                            <div class="small fw-bold">Restroom</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 rounded-3 bg-light facility-card" id="fac_atm">
                            <i class="fas fa-money-bill-wave fa-lg mb-2 text-muted"></i>
                            <div class="small fw-bold">ATM</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 rounded-3 bg-light facility-card" id="fac_food">
                            <i class="fas fa-utensils fa-lg mb-2 text-muted"></i>
                            <div class="small fw-bold">Food</div>
                        </div>
                    </div>
                </div>

                <div class="p-3 rounded-3" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                             style="width: 50px; height: 50px;">
                            <i class="fas fa-headset fa-lg"></i>
                        </div>
                        <div>
                            <div class="small text-uppercase fw-bold text-primary opacity-75">Station Control</div>
                            <div class="fs-5 fw-bold text-dark" id="modalContact">1800-11-2233</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Initialize AOS Animations
        AOS.init({
            duration: 800,
            once: true,
            offset: 100
        });
        
        // Create Background Particles
        function createParticles() {
            const particles = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = Math.random() * 60 + 20 + 'px';
                particle.style.height = particle.style.width;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
                particles.appendChild(particle);
            }
        }
        
        createParticles();
        
        let currentUser = null;
        let allTickets = [];
        
        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = await API.requireAuth();
            
            if (currentUser) {
                // Set user info everywhere
                document.getElementById('navUsername').textContent = currentUser.username;
                document.getElementById('sidebarUsername').textContent = currentUser.username;
                document.getElementById('welcomeUsername').textContent = currentUser.username;
                document.getElementById('profileUsername').value = currentUser.username;
                
                // Load all dashboard data
                await loadDashboardData();
                await loadStations();
                
                // Set minimum date for booking (today)
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('travelDate').min = today;
                
                // Calculate fare when passengers change
                document.getElementById('passengers').addEventListener('input', calculateFare);
            }
            document.getElementById('sourceStation').addEventListener('change', updateFare);
            document.getElementById('destinationStation').addEventListener('change', updateFare);
        });
        
        // Load Dashboard Data
 // --- REPLACE loadDashboardData IN dashboard.html ---
async function loadDashboardData() {
    // 1. Load User & Balance IMMEDIATELY (Critical Data)
    try {
        const userResult = await API.call('/me');
        if (userResult.success) {
            currentUser = userResult.user; 
            
            // Update Balance Everywhere Instantly
            const balance = currentUser.walletBalance.toFixed(2);
            const els = ['dashboardBalance', 'walletBalance', 'sidebarBalance'];
            els.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.textContent = balance;
            });

            // Update Points
            const pointsDisplay = document.getElementById('loyaltyPointsDisplay');
            if (pointsDisplay) pointsDisplay.textContent = currentUser.loyaltyPoints || 0;
        }
    } catch (e) { console.error("Balance Load Error", e); }

    // 2. Load Other Data in Background (Doesn't block the UI)
    loadSecondaryData();
}

// Separate function for heavy lifting
async function loadSecondaryData() {
    try {
        // Load Tickets
        const ticketsResult = await API.call('/tickets/my-tickets');
        if (ticketsResult.success) {
            allTickets = ticketsResult.tickets;
            document.getElementById('totalTickets').textContent = allTickets.length;
            
            const today = new Date().toISOString().split('T')[0];
            const upcoming = allTickets.filter(t => !t.cancelled && t.travelDate >= today).length;
            document.getElementById('upcomingTickets').textContent = upcoming;
            document.getElementById('notificationCount').textContent = upcoming;
            
            if (typeof displayRecentTickets === 'function') displayRecentTickets();
        }
        
        // Load Metro Card
        const cardResult = await API.call('/metrocard/details');
        if (cardResult.success) {
            document.getElementById('metroCardBalance').textContent = cardResult.card.balance.toFixed(2);
        }

        // Load Transactions (The heavy part)
        if (typeof loadTransactions === 'function') loadTransactions();
        
    } catch (error) {
        console.error('Background Data Error:', error);
    }
}
        // Display Recent Tickets with 3D Cards
function displayRecentTickets() {
    const container = document.getElementById('recentTickets');
    const recent = allTickets.slice(0, 3);
    const today = new Date().toISOString().split('T')[0]; // Get today's date (YYYY-MM-DD)
    
    if (recent.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <div style="font-size: 60px; opacity: 0.3; margin-bottom: 20px;">
                    <i class="fas fa-ticket-alt"></i>
                </div>
                <h5 style="color: #64748b;">No bookings yet</h5>
                <p class="text-muted">Start your journey by booking your first ticket!</p>
                <button class="btn-gradient mt-3" onclick="showSection('book-ticket')">
                    <i class="fas fa-plus me-2"></i>Book Ticket
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recent.map(ticket => {
        // --- LOGIC FIX START ---
        let statusClass = 'badge-success';
        let statusText = 'Active';
        
        if (ticket.cancelled) {
            statusClass = 'badge-danger';
            statusText = 'Cancelled';
        } else if (ticket.travelDate < today) {
            statusClass = 'badge-completed';
            statusText = 'Completed';
        }
        // --- LOGIC FIX END ---

        return `
            <div class="ticket-card-3d" data-aos="fade-left">
                <div class="ticket-route">
                    <div class="d-flex align-items-center gap-3">
                        <div class="station-dot"></div>
                        <div>
                            <h5 class="mb-0">${ticket.source.replace(/_/g, ' ').toUpperCase()}</h5>
                            <small class="opacity-75">Source</small>
                        </div>
                    </div>
                    <div class="route-line"></div>
                    <div class="d-flex align-items-center gap-3">
                        <div>
                            <h5 class="mb-0">${ticket.destination.replace(/_/g, ' ').toUpperCase()}</h5>
                            <small class="opacity-75">Destination</small>
                        </div>
                        <div class="station-dot"></div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1">
                            <i class="fas fa-calendar me-2"></i>
                            ${API.formatDate(ticket.travelDate)}
                        </p>
                        <p class="mb-0">
                            <i class="fas fa-users me-2"></i>
                            ${ticket.passengers} Passenger(s)
                        </p>
                    </div>
                    <div class="text-end">
                        <h3 class="mb-2">â‚¹${ticket.fare.toFixed(2)}</h3>
                        <span class="badge-modern ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
        
        // Load Stations
        async function loadStations() {
            try {
                const result = await API.call('/stations');
                if (result.success) {
                    const sourceSelect = document.getElementById('sourceStation');
                    const destSelect = document.getElementById('destinationStation');
                    
                    result.stations.forEach(station => {
                        const option1 = new Option(station.replace(/_/g, ' ').toUpperCase(), station);
                        const option2 = new Option(station.replace(/_/g, ' ').toUpperCase(), station);
                        sourceSelect.add(option1);
                        destSelect.add(option2);
                    });
                }
            } catch (error) {
                console.error('Error loading stations:', error);
            }
        }
        
        // NEW: Asynchronous Fare Calculation
        // FEATURE 1 & 4: SMART CALCULATOR + PEAK HOUR UI
async function updateFare() {
    const source = document.getElementById('sourceStation').value;
    const destination = document.getElementById('destinationStation').value;
    const passengers = parseInt(document.getElementById('passengers').value) || 1;
    // Removed: const fareElement = document.getElementById('calculatedFare'); (Causes crash on 2nd run)
    const infoArea = document.querySelector('.alert'); 
    
    if (source && destination && source !== destination) {
        try {
            // fareElement.textContent = "..."; // Removed this line to prevent crash
            
            const result = await API.call('/tickets/calculate-fare', 'POST', {
                source: source,
                destination: destination,
                passengers: passengers
            });
            
            if (result.success) {
                // The fare is updated via this HTML string injection, so we don't need fareElement.textContent
                let htmlContent = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1"><i class="fas fa-money-bill-wave me-2"></i>Total Fare</h5>
                            <small class="opacity-75">
                                <i class="fas fa-clock me-1"></i> ${result.time} mins â€¢ ${result.distance} km
                            </small>
                        </div>
                        <h2 class="mb-0">â‚¹${result.fare.toFixed(0)}</h2>
                    </div>`;
                
                if (result.is_peak) {
                    htmlContent += `
                    <div class="mt-2" style="background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 8px; font-size: 12px;">
                        <i class="fas fa-bolt text-warning"></i> <strong>Peak Hour Active:</strong> Fares are slightly higher right now.
                    </div>`;
                } else {
                    htmlContent += `
                    <div class="progress-modern mt-3" style="background: rgba(255,255,255,0.2);">
                        <div class="progress-bar-modern" style="width: 100%; background: white;"></div>
                    </div>`;
                }
                
                infoArea.innerHTML = htmlContent;
            }
        } catch (error) {
            console.error(error);
        }
    }
}        // Calculate Fare (old function - keep for compatibility)
        function calculateFare() {
            updateFare();
        }
        
        // Book Ticket Now - NEW FUNCTION
        async function bookTicketNow() {
            console.log('ðŸŽ« Book Now button clicked!');
            
            // Get values
            const source = document.getElementById('sourceStation').value;
            const destination = document.getElementById('destinationStation').value;
            const passengers = parseInt(document.getElementById('passengers').value);
            const travelDate = document.getElementById('travelDate').value;
            
            console.log('Form values:', { source, destination, passengers, travelDate });
            
            // Validation
            if (!source || source === '') {
                alert('âš ï¸ Please select source station');
                return;
            }
            
            if (!destination || destination === '') {
                alert('âš ï¸ Please select destination station');
                return;
            }
            
            if (source === destination) {
                alert('âš ï¸ Source and destination must be different!');
                return;
            }
            
            if (!travelDate) {
                alert('âš ï¸ Please select travel date');
                return;
            }
            
            if (!passengers || passengers < 1 || passengers > 6) {
                alert('âš ï¸ Passengers must be between 1 and 6');
                return;
            }
            
            // Show loading
            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Booking...';
            
            try {
                console.log('ðŸ“¡ Sending booking request...');
                
                const response = await fetch('http://localhost:5000/api/tickets/book', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        source: source,
                        destination: destination,
                        passengers: passengers,
                        travelDate: travelDate
                    })
                });
                
                const result = await response.json();
                console.log('ðŸ“¥ Server response:', result);
                
                if (result.success) {
                    // Use result.ticket.fare to show the actual charged amount
alert('ðŸŽ‰ Ticket Booked Successfully!\n\nFare: â‚¹' + result.ticket.fare.toFixed(2) + '\n\nRedirecting to My Tickets...');
                    
                    // Reset form
                    document.getElementById('bookTicketForm').reset();
                    updateFare();
                    
                    // Reload data
                    await loadDashboardData();
                    
                    // Go to tickets page
                    setTimeout(() => {
                        showSection('my-tickets');
                    }, 1000);
                } else {
                    alert('âŒ Booking Failed!\n\n' + (result.error || result.message || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('âŒ Error:', error);
                alert('âŒ Booking Failed!\n\n' + error.message);
            } finally {
                // Reset button
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
        
        // Make functions global
        window.updateFare = updateFare;
        window.bookTicketNow = bookTicketNow;

        
        // Filter Tickets
        // Updated: Filter Tickets with Button Highlighting
async function filterTickets(filter) {
    // --- 1. HIGHLIGHTING LOGIC START ---
    // List of all filter IDs
    const filters = ['all', 'upcoming', 'past'];
    
    // Loop through them to reset styles
    filters.forEach(type => {
        const btn = document.getElementById(`btn-filter-${type}`);
        if (btn) {
            if (type === filter) {
                // Make selected button PURPLE (Active)
                btn.classList.remove('btn-glass-secondary');
                btn.classList.add('btn-gradient');
            } else {
                // Make other buttons GREY (Inactive)
                btn.classList.remove('btn-gradient');
                btn.classList.add('btn-glass-secondary');
            }
        }
    });
    // --- 1. HIGHLIGHTING LOGIC END ---

    const container = document.getElementById('ticketsList');
    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border" style="color: white;"></div></div>';
    
    try {
        const result = await API.call('/tickets/my-tickets');
        if (result.success) {
            let tickets = result.tickets;
            const today = new Date().toISOString().split('T')[0];
            
            if (filter === 'upcoming') {
                tickets = tickets.filter(t => !t.cancelled && t.travelDate >= today);
            } else if (filter === 'past') {
                tickets = tickets.filter(t => t.travelDate < today);
            }
            
            // --- 2. RESTORED EMPTY STATE LOGIC ---
            if (tickets.length === 0) {
                 container.innerHTML = `
                    <div class="glass-card text-center py-5">
                        <div style="font-size: 60px; opacity: 0.2; margin-bottom: 20px;">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <h5>No tickets found</h5>
                        <p class="text-muted">No ${filter} trips found in your history.</p>
                    </div>
                `;
            } else {
                displayTickets(tickets);
            }
        }
    } catch (error) {
        container.innerHTML = '<p class="text-center text-white">Failed to load tickets</p>';
    }
}
        
        // Display Tickets with Enhanced Cards
        // 1. Updated displayTickets function (Changes onclick to showTicketQR)
// Updated: Display Tickets List with "Completed" Logic
// REPLACE YOUR EXISTING displayTickets FUNCTION WITH THIS:
function displayTickets(tickets) {
    const container = document.getElementById('ticketsList');
    const today = new Date().toISOString().split('T')[0];
    
    if (tickets.length === 0) {
        container.innerHTML = `
            <div class="glass-card text-center py-5">
                <div style="font-size: 60px; opacity: 0.2; margin-bottom: 20px;">
                    <i class="fas fa-inbox"></i>
                </div>
                <h5>No tickets found</h5>
                <p class="text-muted">You haven't booked any tickets yet.</p>
            </div>`;
        return;
    }
    
    container.innerHTML = tickets.map(ticket => {
        let statusClass = 'badge-success';
        let statusText = 'Active';
        let isPast = false;
        
        if (ticket.cancelled) {
            statusClass = 'badge-danger';
            statusText = 'Cancelled';
        } else if (ticket.travelDate < today) {
            statusClass = 'badge-completed';
            statusText = 'Completed';
            isPast = true;
        }

        return `
        <div class="ticket-card-3d mb-3" data-aos="fade-up">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <small class="opacity-75">Ticket #${ticket.ticketId}</small>
                    <h4 class="mb-1">${ticket.source.replace(/_/g, ' ').toUpperCase()} â†’ ${ticket.destination.replace(/_/g, ' ').toUpperCase()}</h4>
                </div>
                <span class="badge-modern ${statusClass}">
                    ${statusText}
                </span>
            </div>
            
            <div class="row mb-3">
                <div class="col-6">
                    <small class="opacity-75">Travel Date</small>
                    <p class="mb-0"><strong>${API.formatDate(ticket.travelDate)}</strong></p>
                </div>
                <div class="col-6">
                    <small class="opacity-75">Passengers</small>
                    <p class="mb-0"><strong>${ticket.passengers}</strong></p>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center pt-3" style="border-top: 1px solid rgba(255,255,255,0.2);">
                <h4 class="mb-0">â‚¹${ticket.fare.toFixed(2)}</h4>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-sm" onclick="emailTicket(${ticket.ticketId})" 
                            style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50px;" 
                            title="Email Receipt">
                        <i class="fas fa-envelope"></i>
                    </button>

                    <button class="btn btn-sm" onclick="downloadPDF(${ticket.ticketId})" 
                            style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50px;" 
                            title="Download PDF">
                        <i class="fas fa-file-pdf"></i>
                    </button>

                    <button class="btn btn-sm" onclick="showTicketQR(${ticket.ticketId})" 
                            style="background: white; color: #4f46e5; border: none; border-radius: 50px; padding: 8px 15px; font-weight: 600;">
                        <i class="fas fa-qrcode me-1"></i> QR
                    </button>
                    
                    ${!ticket.cancelled && !isPast ? `
                        <button class="btn btn-sm" onclick="cancelTicket(${ticket.ticketId})" 
                                style="background: rgba(239,68,68,0.9); color: white; border: none; border-radius: 50px;"
                                title="Cancel Ticket">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `}).join('');
}

// 2. New Function to Show Modal
async function showTicketQR(ticketId) {
    try {
        const result = await API.call(`/tickets/${ticketId}/qrcode`);
        if (result.success) {
            // Set the image in the modal
            const imgElement = document.getElementById('qrImageDisplay');
            imgElement.src = result.qr_code;
            
            // Set the download button link
            const downloadBtn = document.getElementById('qrDownloadBtn');
            downloadBtn.href = result.qr_code;
            downloadBtn.download = `metro-ticket-${ticketId}.png`;
            
            // Open Bootstrap Modal
            const myModal = new bootstrap.Modal(document.getElementById('qrModal'));
            myModal.show();
        }
    } catch (error) {
        console.error(error);
        API.showAlert('Failed to load QR code', 'danger');
    }
}
        
        // Cancel Ticket
        async function cancelTicket(ticketId) {
            if (!confirm('âš ï¸ Are you sure you want to cancel this ticket?')) return;
            
            try {
                const result = await API.call(`/tickets/cancel/${ticketId}`, 'POST');
                if (result.success) {
                    API.showAlert(`âœ… Ticket cancelled! Refund: â‚¹${result.refund.toFixed(2)}`, 'success');
                    await loadDashboardData();
                    filterTickets('all');
                }
            } catch (error) {
                API.showAlert(error.message, 'danger');
            }
        }
        
        // Recharge Wallet Form
        // REPLACE THE EXISTING 'rechargeForm' LISTENER WITH THIS:

// Recharge Wallet Form
document.getElementById('rechargeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const amountInput = document.getElementById('rechargeAmount');
    const amount = parseFloat(amountInput.value);
    const btn = e.submitter || e.target.querySelector('button[type="submit"]');
    
    // 1. Visual Feedback
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    btn.disabled = true;
    
    try {
        // --- FIX: ADDED '/api' PREFIX TO URL ---
        const result = await API.call('/user/wallet/recharge', 'POST', { amount });
        
        if (result.success) {
            API.showAlert(`ðŸ’° Wallet recharged with â‚¹${amount}!`, 'success');
            document.getElementById('rechargeForm').reset();
            
            // Instantly update UI with new balance
            const newBalance = result.newBalance.toFixed(2);
            const els = ['dashboardBalance', 'walletBalance', 'sidebarBalance'];
            els.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.textContent = newBalance;
            });
            
            // Update global user object
            if(currentUser) currentUser.walletBalance = result.newBalance;

            if(typeof loadTransactions === 'function') loadTransactions();
        }
    } catch (error) {
        API.showAlert(error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});
        
        function setAmount(amount) {
            document.getElementById('rechargeAmount').value = amount;
        }
         
        // Submit Feedback Form
        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const text = document.getElementById('feedbackText').value;
            const type = document.getElementById('feedbackType').value.split(' ')[1] || 'feedback';
            
            try {
                const result = await API.call('/feedback/submit', 'POST', { text, type });
                if (result.success) {
                    API.showAlert('ðŸ“ Feedback submitted successfully!', 'success');
                    document.getElementById('feedbackForm').reset();
                    await loadMyFeedbacks();
                }
            } catch (error) {
                API.showAlert(error.message, 'danger');
            }
        });
        
        // Load My Feedbacks
        async function loadMyFeedbacks() {
            try {
                const result = await API.call('/feedback/my-feedbacks');
                if (result.success) {
                    const container = document.getElementById('myFeedbacks');
                    
                    if (result.feedbacks.length === 0) {
                        container.innerHTML = '<p class="text-muted">No feedbacks yet</p>';
                        return;
                    }
                    
                    container.innerHTML = result.feedbacks.map(fb => `
                        <div class="glass-card mb-3" style="background: white;">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge-modern badge-info">${fb.type.toUpperCase()}</span>
                                <small class="text-muted">${API.formatDateTime(fb.timestamp)}</small>
                            </div>
                            <p class="mb-0">${fb.text}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading feedbacks:', error);
            }
        }
        
        // Change Password Form
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            
            try {
                const result = await API.call('/user/change-password', 'POST', { oldPassword, newPassword });
                if (result.success) {
                    API.showAlert('ðŸ” Password changed successfully!', 'success');
                    document.getElementById('changePasswordForm').reset();
                }
            } catch (error) {
                API.showAlert(error.message, 'danger');
            }
        });
        
        // Show Section
       // Updated showSection function (Fixes the crash after booking)
function showSection(section) {
    // 1. Hide all sections
    document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
    
    // 2. Remove active class from all links
    document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
    
    // 3. Show selected section
    const sectionEl = document.getElementById(`${section}-section`);
    if (sectionEl) sectionEl.style.display = 'block';
    
    // 4. FIX: Highlight the correct sidebar link safely
    // Instead of relying on 'event.target' (which crashes on auto-redirect),
    // we find the link that points to this section using its onclick attribute.
    const activeLink = document.querySelector(`.sidebar-link[onclick*="'${section}'"]`);
    if (activeLink) {
        activeLink.classList.add('active');
    }
    
    // 5. Reinitialize AOS animations
    if (typeof AOS !== 'undefined') AOS.refresh();
    
    // 6. Load data for specific sections
    if (section === 'my-tickets') {
        if (typeof filterTickets === 'function') filterTickets('all');
    } else if (section === 'metro-card') {
        if (typeof loadMetroCard === 'function') loadMetroCard();
    } else if (section === 'feedback') {
        if (typeof loadMyFeedbacks === 'function') loadMyFeedbacks();
    } else if (section === 'transactions') {
        if (typeof loadTransactions === 'function') { loadTransactions(); loadAnalytics(); }
    } else if (section === 'analytics') {
        if (typeof loadAnalytics === 'function') loadAnalytics();
    } else if (section === 'fare-calculator') {
        if (typeof loadCalculatorStations === 'function') loadCalculatorStations();
    }
}
        
        // Make functions global
        window.showSection = showSection;
        window.filterTickets = filterTickets;
        window.cancelTicket = cancelTicket;
        window.setAmount = setAmount;

                // Load Analytics
        

        // dashboard.html - NEW FUNCTION for Real DB Journey History
async function loadJourneyHistory() {
    const container = document.getElementById('journeyTimeline');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div></div>';

    try {
        // We reuse the tickets API because it has all the data we need
        const result = await API.call('/tickets/my-tickets');
        
        if (result.success && result.tickets.length > 0) {
            // Sort by date (newest first)
            const sortedTickets = result.tickets.sort((a, b) => new Date(b.travelDate) - new Date(a.travelDate));
            
            container.innerHTML = sortedTickets.map(t => {
                const isPast = new Date(t.travelDate) < new Date();
                const statusColor = t.cancelled ? 'danger' : (isPast ? 'secondary' : 'success');
                const icon = t.cancelled ? 'times-circle' : 'check-circle';
                
                return `
                <div class="d-flex gap-3 mb-4" data-aos="fade-up">
                    <div class="d-flex flex-column align-items-center">
                        <div style="width: 40px; height: 40px; background: var(--${statusColor}); 
                                    border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                    color: white; z-index: 2;">
                            <i class="fas fa-${icon}"></i>
                        </div>
                        <div style="width: 2px; height: 100%; background: #e2e8f0; margin-top: -5px; min-height: 50px;"></div>
                    </div>
                    <div class="glass-card w-100 py-3 px-4" style="background: white;">
                        <div class="d-flex justify-content-between">
                            <h6 class="fw-bold mb-1">${t.source.toUpperCase()} <i class="fas fa-arrow-right mx-2 text-muted"></i> ${t.destination.toUpperCase()}</h6>
                            <small class="text-muted">${API.formatDate(t.travelDate)}</small>
                        </div>
                        <p class="mb-0 small text-muted">
                            <i class="fas fa-users me-1"></i> ${t.passengers} Passengers â€¢ 
                            <i class="fas fa-rupee-sign me-1"></i> ${t.fare}
                            ${t.cancelled ? '<span class="badge bg-danger ms-2">Cancelled</span>' : ''}
                        </p>
                    </div>
                </div>
                `;
            }).join('');
            
            // Remove the last vertical line
            const lastLine = container.lastElementChild.querySelector('.d-flex.flex-column div:last-child');
            if(lastLine) lastLine.style.display = 'none';

        } else {
            container.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    Your journey history will appear here after your first trip!
                </div>`;
        }
    } catch (e) {
        console.error(e);
        container.innerHTML = '<p class="text-danger text-center">Failed to load history</p>';
    }
}
        
        // Display Favorite Routes
        function displayFavoriteRoutes(routes) {
            const container = document.getElementById('favoriteRoutesList');
            
            if (routes.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No travel history yet</p>';
                return;
            }
            
            container.innerHTML = routes.map((route, idx) => `
                <div class="d-flex justify-content-between align-items-center p-3 mb-2" 
                     style="background: rgba(102, 126, 234, 0.1); border-radius: 15px;">
                    <div class="d-flex align-items-center gap-3">
                        <div style="width: 40px; height: 40px; background: var(--primary); 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; color: white; font-weight: 700;">
                            ${idx + 1}
                        </div>
                        <div>
                            <h6 class="mb-0">${route.source.replace(/_/g, ' ').toUpperCase()} â†’ ${route.destination.replace(/_/g, ' ').toUpperCase()}</h6>
                            <small class="text-muted">${route.trip_count} trips</small>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-gradient" onclick="quickBook('${route.source}', '${route.destination}')">
                        <i class="fas fa-redo me-1"></i>Rebook
                    </button>
                </div>
            `).join('');
        }
        
        // Display Spending Chart (Simple bars)
        function displaySpendingChart(data) {
            const container = document.getElementById('monthlyChart');
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No spending data available</p>';
                return;
            }
            
            const maxAmount = Math.max(...data.map(d => d.amount));
            
            container.innerHTML = data.reverse().map(item => `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small><strong>${item.month}</strong></small>
                        <small><strong>â‚¹${item.amount.toFixed(2)}</strong> (${item.count} trips)</small>
                    </div>
                    <div class="progress-modern" style="height: 30px;">
                        <div class="progress-bar-modern" style="width: ${(item.amount/maxAmount)*100}%; 
                             background: var(--primary); display: flex; align-items: center; 
                             padding-left: 10px; color: white; font-weight: 600;">
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Quick Book from Favorites
        function quickBook(source, destination) {
            document.getElementById('sourceStation').value = source;
            document.getElementById('destinationStation').value = destination;
            showSection('book-ticket');
            calculateFare();
        }
        
        // Load Transactions
        // ---------------------------------------------------------
        // NEW: Enhanced Transaction History & Analytics
        // ---------------------------------------------------------

        // REPLACE loadTransactions FUNCTION
async function loadTransactions() {
    try {
        const result = await API.call('/user/transactions');
        if (result.success) {
            const transactions = result.transactions;
            
            // 1. Update Main Table (Transactions Page)
            const tbody = document.getElementById('transactionsTable');
            if (tbody) {
                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No transactions found</td></tr>';
                } else {
                    tbody.innerHTML = transactions.map(t => {
                        // Determine Color and Icon based on Type
                        const isCredit = t.type === 'CREDIT';
                        const isCancelled = t.cancelled;
                        
                        let amountClass = isCredit ? 'text-success' : 'text-danger';
                        let amountSign = isCredit ? '+' : '-';
                        let statusBadge = isCredit ? '<span class="badge bg-success">Success</span>' : 
                                          (isCancelled ? '<span class="badge bg-warning text-dark">Refunded</span>' : '<span class="badge bg-primary">Booked</span>');
                        
                        // Handle Refunded Tickets
                        if (isCancelled) {
                            amountClass = 'text-success';
                            amountSign = '+'; // It's a refund
                        }

                        return `
                        <tr>
                            <td>${API.formatDateTime(t.date)}</td>
                            <td>${t.description.replace(/_/g, ' ').toUpperCase()}</td>
                            <td>${t.type === 'TICKET' ? 'Ticket' : 'Wallet'}</td>
                            <td class="${amountClass} fw-bold">${amountSign}â‚¹${t.amount.toFixed(2)}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `}).join('');
                }
            }

            // 2. Update Recent Transactions Widget (Wallet Page)
            const historyContainer = document.getElementById('transactionHistory');
            if (historyContainer) {
                if (transactions.length === 0) {
                    historyContainer.innerHTML = '<div class="text-center py-4 text-muted">No recent activity</div>';
                } else {
                    historyContainer.innerHTML = transactions.map(t => {
                        const isCredit = t.type === 'CREDIT';
                        const isCancelled = t.cancelled;
                        
                        // Icon Logic
                        let icon = isCredit ? 'fa-bolt' : 'fa-train';
                        let bgClass = isCredit ? '#d1fae5' : '#e0e7ff'; // Green vs Blue background
                        let iconColor = isCredit ? '#059669' : '#4f46e5';

                        if (isCancelled) {
                             icon = 'fa-undo';
                             bgClass = '#fee2e2';
                             iconColor = '#dc2626';
                        }

                        return `
                        <div class="d-flex justify-content-between align-items-center p-3 mb-2" 
                             style="background: white; border-radius: 12px; border-left: 4px solid ${iconColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            
                            <div class="d-flex align-items-center gap-3">
                                <div style="width: 40px; height: 40px; background: ${bgClass}; 
                                            border-radius: 10px; display: flex; align-items: center; justify-content: center; 
                                            color: ${iconColor};">
                                    <i class="fas ${icon}"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold" style="font-size: 14px;">${t.description.replace(/_/g, ' ').toUpperCase()}</h6>
                                    <small class="text-muted" style="font-size: 11px;">
                                        ${API.formatDateTime(t.date)}
                                    </small>
                                </div>
                            </div>
                            
                            <div class="text-end">
                                <h6 class="mb-0 fw-bold ${isCredit || isCancelled ? 'text-success' : 'text-danger'}">
                                    ${isCredit || isCancelled ? '+' : '-'}â‚¹${t.amount.toFixed(2)}
                                </h6>
                                <small class="text-muted" style="font-size: 11px;">${isCredit ? 'Recharge' : (isCancelled ? 'Refund' : 'Debit')}</small>
                            </div>
                        </div>
                    `}).join('');
                }
            }
        }
    } catch (error) {
        console.error('Error loading transactions:', error);
    }
}

        // ---------------------------------------------------------
        // NEW: Realistic Chart.js Implementation
        // ---------------------------------------------------------
        
       
        let spendingChartInstance = null; // Global variable to hold chart instance

async function loadAnalytics() {
    try {
        const result = await API.call('/user/analytics');
        if (result.success) {
            const analytics = result.analytics;
            
            // 1. Update Basic Stats
            if(document.getElementById('totalSpent')) 
                document.getElementById('totalSpent').textContent = analytics.total_spent.toFixed(2);
            if(document.getElementById('totalTransactions')) 
                document.getElementById('totalTransactions').textContent = analytics.total_bookings;
            
            // 2. Fix the "0 km" glitch (Distance Logic)
            let dist = analytics.total_distance;
            // Fallback: If DB says 0 but you have bookings (old data), estimate 12km per trip
            if ((!dist || dist === 0) && analytics.total_bookings > 0) {
                dist = analytics.total_bookings * 12.0; 
            }
            
            const distElement = document.getElementById('totalDistance');
            if (distElement) {
                distElement.textContent = dist.toFixed(1) + " km";
            }

            // 3. Update Average
            const avg = analytics.total_bookings > 0 ? 
                (analytics.total_spent / analytics.total_bookings).toFixed(2) : '0';
            if(document.getElementById('avgPerTrip'))
                document.getElementById('avgPerTrip').textContent = avg;
            
            // 4. Render Favorite Routes
            if (typeof displayFavoriteRoutes === 'function') {
                displayFavoriteRoutes(analytics.favorite_routes);
            }
            
            // 5. RENDER THE REAL CHART (Chart.js)
            if (typeof renderSpendingChart === 'function') {
                renderSpendingChart(analytics.monthly_spending);
            }
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
    }
}

        function renderSpendingChart(data) {
            const ctx = document.getElementById('spendingChart');
            if (!ctx) return;

            // Prepare Data
            // If data is empty, mock it for visual demonstration if you want, or show empty
            const labels = data.length ? data.map(d => d.month) : ['Jan', 'Feb', 'Mar']; 
            const values = data.length ? data.map(d => d.amount) : [0, 0, 0];

            // Destroy previous chart if exists to prevent glitches
            if (spendingChartInstance) {
                spendingChartInstance.destroy();
            }

            // Create New Chart
            spendingChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Spending (â‚¹)',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderWidth: 3,
                        tension: 0.4, // Smooth curves
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#764ba2',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // Calculate Detailed Fare
        function calculateDetailedFare() {
            const source = document.getElementById('calcSource').value;
            const dest = document.getElementById('calcDest').value;
            const passengers = parseInt(document.getElementById('calcPassengers').value);
            
            if (!source || !dest) {
                API.showAlert('Please select both stations', 'warning');
                return;
            }
            
            if (source === dest) {
                API.showAlert('Source and destination must be different', 'warning');
                return;
            }
            
            // Calculate (simple: â‚¹50 per person)
            const totalFare = passengers * 50;
            const distance = Math.floor(Math.random() * 15) + 5; // Random 5-20 km
            const time = Math.floor(distance * 3); // 3 mins per km
            
            document.getElementById('farePassengers').textContent = passengers;
            document.getElementById('fareDistance').textContent = distance + ' km';
            document.getElementById('fareTime').textContent = time + ' mins';
            document.getElementById('fareTotalAmount').textContent = totalFare;
            document.getElementById('fareResult').style.display = 'block';
        }
        
        // Book from Calculator
        function bookFromCalculator() {
            const source = document.getElementById('calcSource').value;
            const dest = document.getElementById('calcDest').value;
            const passengers = document.getElementById('calcPassengers').value;
            
            document.getElementById('sourceStation').value = source;
            document.getElementById('destinationStation').value = dest;
            document.getElementById('passengers').value = passengers;
            
            showSection('book-ticket');
            calculateFare();
        }
        
        // Load calculator stations
        function loadCalculatorStations() {
            const sourceSelect = document.getElementById('calcSource');
            const destSelect = document.getElementById('calcDest');
            
            const mainSource = document.getElementById('sourceStation');
            
            // Copy options
            for (let i = 1; i < mainSource.options.length; i++) {
                sourceSelect.add(mainSource.options[i].cloneNode(true));
                destSelect.add(mainSource.options[i].cloneNode(true));
            }
        }
        
        // Download Ticket QR Code
        async function downloadTicketQR(ticketId) {
            try {
                const result = await API.call(`/tickets/${ticketId}/qrcode`);
                if (result.success) {
                    // Show QR in modal or download
                    const link = document.createElement('a');
                    link.href = result.qr_code;
                    link.download = `ticket-${ticketId}-qr.png`;
                    link.click();
                    API.showAlert('QR Code downloaded! ðŸ“±', 'success');
                }
            } catch (error) {
                API.showAlert('Failed to generate QR code', 'danger');
            }
        }
        
        // Dark Mode Toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
        }
        
        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        
        // Update showSection to load data
        const originalShowSection = showSection;
        showSection = function(section) {
            originalShowSection(section);
            
            if (section === 'transactions') {
                loadTransactions();
                loadAnalytics();
            } else if (section === 'analytics') {
                loadAnalytics();
            } else if (section === 'fare-calculator') {
                loadCalculatorStations();
            }
            // Inside your existing showSection function, add this line:
else if (section === 'journey-history') {
    loadJourneyHistory(); // <--- ADD THIS
    loadAnalytics();      // Load stats too
}
        };
        // FEATURE 2: DOWNLOAD PDF FUNCTION
async function downloadPDF(ticketId) {
    try {
        API.showAlert('Generating PDF... Please wait', 'info');
        const result = await API.call(`/tickets/${ticketId}/pdf`);
        
        if (result.success) {
            const link = document.createElement('a');
            link.href = result.pdf_file;
            link.download = result.filename;
            link.click();
            API.showAlert('Receipt downloaded successfully!', 'success');
        }
    } catch (error) {
        API.showAlert('Failed to download PDF', 'danger');
    }
}
        // ---------------------------------------------------------
        // FIXED METRO CARD LOGIC (Smooth Toggle)
        // ---------------------------------------------------------

        // dashboard.html - FIXED Toggle Function
// Global flag to prevent double-clicking
let isProcessingToggle = false;

async function toggleAutoRecharge(checkbox) {
    // 1. Check if already processing to stop spam clicking
    if (isProcessingToggle) {
        checkbox.checked = !checkbox.checked; // Revert immediately
        return;
    }

    const isEnabled = checkbox.checked;
    const statusLabel = document.getElementById('autoRechargeLabel');
    isProcessingToggle = true;

    // 2. Optimistic UI: Update text immediately so it feels fast
    if (statusLabel) statusLabel.textContent = isEnabled ? 'On' : 'Off';

    try {
        // 3. Send request to server
        const result = await API.call('/metrocard/autorecharge', 'POST', { enable: isEnabled });
        
        if (result.success) {
            API.showAlert(`Auto-recharge ${isEnabled ? 'Enabled' : 'Disabled'}`, 'success');
            // SUCCESS: We don't need to do anything else, the switch is already in the right spot
        } else {
            throw new Error(result.error || "Update failed");
        }
    } catch (error) {
        console.error(error);
        API.showAlert('Failed to update settings', 'danger');
        
        // ERROR: Revert the switch and label back to previous state
        checkbox.checked = !isEnabled;
        if (statusLabel) statusLabel.textContent = !isEnabled ? 'On' : 'Off';
    } finally {
        isProcessingToggle = false;
    }
}

// Make it available globally
window.toggleAutoRecharge = toggleAutoRecharge;
        // Metro Card Loader
        async function loadMetroCard() {
            try {
                const result = await API.call('/metrocard/details');
                if (result.success) {
                    const card = result.card;
                    
                    document.getElementById('metroCardDetails').innerHTML = `
                        <div class="glass-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; position: relative; overflow: hidden;" data-aos="flip-left">
                            <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                            <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                            
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <div>
                                    <small class="opacity-75">Metro Smart Card</small>
                                    <h3 class="mb-0">Card #${card.cardNumber}</h3>
                                </div>
                                <div style="font-size: 40px;">
                                    <i class="fas fa-wifi"></i>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <small class="opacity-75">Balance</small>
                                <h1 style="font-size: 3rem; font-weight: 800;">â‚¹${card.balance.toFixed(2)}</h1>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="opacity-75">Auto-Recharge</small>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoRechargeSwitch" 
                                               ${card.autoRechargeEnabled ? 'checked' : ''} 
                                               onchange="window.toggleAutoRecharge(this)">
                                        <label class="form-check-label text-white" for="autoRechargeSwitch" id="autoRechargeLabel">
                                            ${card.autoRechargeEnabled ? 'On' : 'Off'}
                                        </label>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="opacity-75">Threshold</small>
                                    <p class="mb-0"><strong>â‚¹${card.minBalanceThreshold}</strong></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-card mt-4">
                            <h5 class="mb-3"><i class="fas fa-plus-circle me-2"></i>Recharge Card</h5>
                            <form id="rechargeCardForm">
                                <div class="form-group-modern mb-3">
                                    <label class="form-label-modern">Amount (â‚¹)</label>
                                    <div class="position-relative">
                                        <i class="form-icon fas fa-rupee-sign"></i>
                                        <input type="number" class="form-control-modern" id="cardRechargeAmount" 
                                               min="50" max="5000" placeholder="Enter amount" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn-gradient w-100">
                                    <i class="fas fa-bolt me-2"></i>Recharge Card
                                </button>
                            </form>
                        </div>
                    `;
                    
                    // Attach event listener for recharge form
                    // ... inside loadMetroCard function ...
const rechargeForm = document.getElementById('rechargeCardForm');
if(rechargeForm) {
    rechargeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('cardRechargeAmount').value);
        try {
            // --- FIX: ADDED '/api' PREFIX TO URL ---
            const res = await API.call('/metrocard/recharge', 'POST', { amount });
            if (res.success) {
                API.showAlert('ðŸ’³ Metro card recharged!', 'success');
                await loadMetroCard(); 
                await loadDashboardData(); 
            }
        } catch (error) {
            API.showAlert(error.message, 'danger');
        }
    });
}
                }
            } catch (error) {
                console.error("Load card error:", error);
                document.getElementById('metroCardDetails').innerHTML = '<p class="text-white">Failed to load metro card</p>';
            }
        }

        // --- NEW FUNCTIONS ---

// 1. Load Notifications
// Update your existing loadNotifications function
async function loadNotifications() {
    try {
        const result = await API.call('/notifications');
        const list = document.getElementById('notifList');
        const badge = document.getElementById('notificationCount');
        
        if (result.success && result.notifications.length > 0) {
            // Update the list
            list.innerHTML = result.notifications.map(n => `
                <li class="dropdown-item border-bottom">
                    <div class="small fw-bold">${n.message}</div>
                    <div class="text-muted" style="font-size: 10px;">${API.formatDateTime(n.date)}</div>
                </li>
            `).join('');

            // ONLY show badge if it was hidden and we have data (or handle 'read' logic if needed)
            // For now, this keeps the count updated:
            if(badge.style.display !== 'none') {
                 badge.textContent = result.notifications.length;
            }
        }
    } catch(e) { console.log(e); }
}

// 2. Redeem Points
// dashboard.html - Updated redeemPoints function
async function redeemPoints() {
    // 1. Get current points from the display
    const pointsText = document.getElementById('loyaltyPointsDisplay').textContent;
    const points = parseInt(pointsText) || 0;

    // 2. Check locally first
    if (points < 50) {
        API.showAlert(`You need 50 points to redeem. You have ${points}.`, 'warning');
        return; // Stop here, don't call the API
    }

    // 3. Proceed if enough points
    if(!confirm("Redeem 50 Points for â‚¹20 Wallet Balance?")) return;
    
    try {
        const result = await API.call('/loyalty/redeem', 'POST');
        if (result.success) {
            API.showAlert(result.message, 'success');
            // Reload data to update balance and points display
            loadDashboardData(); 
        } else {
            API.showAlert(result.error, 'warning');
        }
    } catch(e) { 
        API.showAlert('Redemption failed', 'danger'); 
    }
}

// 3. Email Ticket
async function emailTicket(ticketId) {
    try {
        API.showAlert('Sending email...', 'info');
        const result = await API.call(`/tickets/${ticketId}/email`, 'POST');
        if (result.success) API.showAlert(result.message, 'success');
    } catch(e) { API.showAlert('Email failed', 'danger'); }
}

// 4. Report Lost Item
async function reportLostItem(e) {
    e.preventDefault();

    const item = document.getElementById('lostItemName').value.trim();
    const descEl = document.getElementById('lostItemDesc');
    const description = descEl ? descEl.value.trim() : item;

    if (!item) {
        API.showAlert('Please enter lost item details', 'warning');
        return;
    }

    try {
        const result = await API.call(
            '/api/lost-found/report',   // âœ… CORRECT URL
            'POST',
            { item, description }
        );

        if (result.success) {
            API.showAlert('Report Submitted Successfully', 'success');
            if (typeof loadLostFound === 'function') loadLostFound();
            e.target.reset();
        } else {
            API.showAlert(result.error || 'Failed to report', 'danger');
        }
    } catch (err) {
        console.error(err);
        API.showAlert('Server error while reporting', 'danger');
    }
}
// --- ADD THIS TO YOUR SCRIPT SECTION ---

// 1. New function specifically for the Dashboard "Quick Report" widget
async function submitQuickReport() {
    const inputField = document.getElementById('quickLostItemInput');
    const item = inputField.value.trim();

    if (!item) {
        API.showAlert('âš ï¸ Please type what you lost first!', 'warning');
        return;
    }

    // Visual feedback on button
    const btn = event.target; // Uses the global event object safely
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
        const result = await API.call('/lost-found/report', 'POST', { 
            item: item,
            description: "Reported via Dashboard Quick Widget" 
        });

        if (result.success) {
            API.showAlert('âœ… Report Submitted! We are searching for your item.', 'success');
            inputField.value = ''; // Clear input
            
            // If the Lost & Found section is open, refresh the list
            if (document.getElementById('lost-found-section').style.display !== 'none') {
                loadLostFound();
            }
        } else {
            API.showAlert('âŒ ' + (result.error || 'Failed to report'), 'danger');
        }
    } catch (error) {
        console.error(error);
        API.showAlert('âŒ Server Error', 'danger');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}


// 5. Load Lost & Found
async function loadLostFound() {
    try {
        const result = await API.call('/lostfound/my');
        const container = document.getElementById('lostFoundList');
        if(result.success) {
            container.innerHTML = result.reports.length ? result.reports.map(r => `
                <div class="d-flex justify-content-between align-items-center p-3 mb-2 bg-light rounded">
                    <div>
                        <h6 class="mb-0 fw-bold">${r.item}</h6>
                        <small class="text-muted">${r.description}</small>
                    </div>
                    <span class="badge ${r.status === 'FOUND' ? 'bg-success' : 'bg-warning text-dark'}">${r.status}</span>
                </div>
            `).join('') : '<p class="text-muted">No reports filed.</p>';
        }
    } catch(e) { }
}
document.addEventListener('DOMContentLoaded', () => {
    // ... existing code ...
    setInterval(loadNotifications, 30000); // Check notifications every 30s
    setTimeout(loadNotifications, 1000);   // Check on load
});
// CALL THESE ON LOAD
// Add this function to make the red number disappear
function markAsRead() {
    const badge = document.getElementById('notificationCount');
    if (badge) {
        badge.style.display = 'none'; // Hides the badge immediately
        // Optional: Reset text to 0 so it stays 0 if it reappears
        badge.textContent = '0'; 
    }
}

// Function to fetch and display station info
// --- NEW FUNCTION: View Station Info ---
// Function to fetch and display station info
async function viewStationInfo(elementId) {
    console.log("1. Info button clicked for:", elementId);
    
    // Get the selected station value
    const selectElement = document.getElementById(elementId);
    if (!selectElement) {
        console.error("âŒ Could not find dropdown with ID:", elementId);
        return;
    }
    
    const stationName = selectElement.value;
    console.log("2. Selected station:", stationName);

    if (!stationName) {
        API.showAlert('âš ï¸ Please select a station first', 'warning');
        return;
    }

    try {
        console.log("3. Fetching data...");
        const result = await API.call(`/stations/info/${stationName}`);
        console.log("4. API Result:", result);
        
        if (result.success) {
            const s = result.station;
            
            // CHECK: Do these elements exist?
            const modalTitle = document.getElementById('modalStationName');
            if (!modalTitle) {
                console.error("âŒ CRITICAL: Modal HTML missing! Check if modal code is in dashboard.html");
                alert("Error: Station Info Modal HTML is missing from this page.");
                return;
            }

            // 1. Update Text
            modalTitle.textContent = s.name.replace(/_/g, ' ').toUpperCase();
            document.getElementById('modalContact').textContent = s.contact_number || '1800-11-2233';
            document.getElementById('modalStationId').textContent = "ID: #" + Math.floor(Math.random() * 1000); // Simulated ID
            
            // 2. Helper to Toggle Icons
            const updateFacility = (id, isActive, activeColor) => {
                const card = document.getElementById(id);
                if (!card) return; // Skip if missing
                
                const icon = card.querySelector('i');
                
                if (isActive) {
                    card.className = `p-3 rounded-3 text-white facility-card ${activeColor} shadow-sm`;
                    if(icon) {
                        icon.classList.remove('text-muted');
                        icon.classList.add('text-white');
                    }
                } else {
                    card.className = 'p-3 rounded-3 bg-light facility-card opacity-50'; // Grayed out
                    if(icon) {
                        icon.classList.remove('text-white');
                        icon.classList.add('text-muted');
                    }
                }
            };

            // 3. Update Grid (Using data from DB)
            // Note: s.has_wifi might be 1 or 0, which works as true/false in JS
            updateFacility('fac_wifi', s.has_wifi, 'bg-primary');
            updateFacility('fac_parking', s.has_parking, 'bg-warning');
            updateFacility('fac_access', s.is_accessible, 'bg-info');
            updateFacility('fac_wc', s.has_restroom, 'bg-success');
            updateFacility('fac_atm', s.has_atm, 'bg-danger');
            updateFacility('fac_food', true, 'bg-secondary'); // Default on

            // 4. Show Modal (Safe Bootstrap Call)
            console.log("5. Opening Modal...");
            const modalEl = document.getElementById('stationInfoModal');
            const myModal = new bootstrap.Modal(modalEl);
            myModal.show();
        }
    } catch (error) {
        console.error("âŒ Error in viewStationInfo:", error);
        API.showAlert('Failed to load details. See console (F12).', 'danger');
    }
}
    </script>
</body>
</html>

